<!DOCTYPE html>
<html><head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
                <meta content="utf-8" http-equiv="encoding">
                <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Heroquest solo assistant</title><link href="Heroquest%20solo%20assistant_files/resstyle.css" rel="stylesheet">

                <script>
                // from http://stackoverflow.com/questions/5515869/string-length-in-bytes-in-javascript
                // using UTF8 strings I noticed that the javascript .length of a string returned less
                // characters than they actually were
                var pendingSendMessages = [];
                var ws = null;
                var comTimeout = null;
                var failedConnections = 0;

                function byteLength(str) {
                    // returns the byte length of an utf8 string
                    var s = str.length;
                    for (var i=str.length-1; i>=0; i--) {
                        var code = str.charCodeAt(i);
                        if (code > 0x7f && code <= 0x7ff) s++;
                        else if (code > 0x7ff && code <= 0xffff) s+=2;
                        if (code >= 0xDC00 && code <= 0xDFFF) i--; //trail surrogate
                    }
                    return s;
                }

                var paramPacketize = function (ps){
                    var ret = '';
                    for (var pkey in ps) {
                        if( ret.length>0 )ret = ret + '|';
                        var pstring = pkey+'='+ps[pkey];
                        var pstring_length = byteLength(pstring);
                        pstring = pstring_length+'|'+pstring;
                        ret = ret + pstring;
                    }
                    return ret;
                };

                function openSocket(){
                    ws_wss = "ws";
                    try{
                        ws_wss = document.location.protocol.startsWith('https')?'wss':'ws';
                    }catch(ex){}

                    try{
                        ws = new WebSocket(ws_wss + '://127.0.0.1:59946/');
                        console.debug('opening websocket');
                        ws.onopen = websocketOnOpen;
                        ws.onmessage = websocketOnMessage;
                        ws.onclose = websocketOnClose;
                        ws.onerror = websocketOnError;
                    }catch(ex){ws=false;alert('websocketnot supported or server unreachable');}
                }
                openSocket();

                function websocketOnMessage (evt){
                    var received_msg = evt.data;

                    if( received_msg[0]=='0' ){ /*show_window*/
                        var index = received_msg.indexOf(',')+1;
                        /*var idRootNodeWidget = received_msg.substr(0,index-1);*/
                        var content = received_msg.substr(index,received_msg.length-index);

                        document.body.innerHTML = decodeURIComponent(content);
                    }else if( received_msg[0]=='1' ){ /*update_widget*/
                        var focusedElement=-1;
                        var caretStart=-1;
                        var caretEnd=-1;
                        if (document.activeElement)
                        {
                            focusedElement = document.activeElement.id;
                            try{
                                caretStart = document.activeElement.selectionStart;
                                caretEnd = document.activeElement.selectionEnd;
                            }catch(e){}
                        }
                        var index = received_msg.indexOf(',')+1;
                        var idElem = received_msg.substr(1,index-2);
                        var content = received_msg.substr(index,received_msg.length-index);

                        var elem = document.getElementById(idElem);
                        try{
                            elem.insertAdjacentHTML('afterend',decodeURIComponent(content));
                            elem.parentElement.removeChild(elem);
                        }catch(e){
                            /*Microsoft EDGE doesn't support insertAdjacentHTML for SVGElement*/
                            var ns = document.createElementNS("http://www.w3.org/2000/svg",'tmp');
                            ns.innerHTML = decodeURIComponent(content);
                            elem.parentElement.replaceChild(ns.firstChild, elem);
                        }

                        var elemToFocus = document.getElementById(focusedElement);
                        if( elemToFocus != null ){
                            elemToFocus.focus();
                            try{
                                elemToFocus = document.getElementById(focusedElement);
                                if(caretStart>-1 && caretEnd>-1) elemToFocus.setSelectionRange(caretStart, caretEnd);
                            }catch(e){}
                        }
                    }else if( received_msg[0]=='2' ){ /*javascript*/
                        var content = received_msg.substr(1,received_msg.length-1);
                        try{
                            eval(content);
                        }catch(e){console.debug(e.message);};
                    }else if( received_msg[0]=='3' ){ /*ack*/
                        pendingSendMessages.shift() /*remove the oldest*/
                        if(comTimeout!=null)
                            clearTimeout(comTimeout);
                    }
                };

                /*this uses websockets*/
                var sendCallbackParam = function (widgetID,functionName,params /*a dictionary of name:value*/){
                    var paramStr = '';
                    if(params!=null) paramStr=paramPacketize(params);
                    var message = encodeURIComponent(unescape('callback' + '/' + widgetID+'/'+functionName + '/' + paramStr));
                    pendingSendMessages.push(message);
                    if( pendingSendMessages.length < 1000 ){
                        ws.send(message);
                        if(comTimeout==null)
                            comTimeout = setTimeout(checkTimeout, 1000);
                    }else{
                        console.debug('Renewing connection, ws.readyState when trying to send was: ' + ws.readyState)
                        renewConnection();
                    }
                };

                /*this uses websockets*/
                var sendCallback = function (widgetID,functionName){
                    sendCallbackParam(widgetID,functionName,null);
                };

                function renewConnection(){
                    // ws.readyState:
                    //A value of 0 indicates that the connection has not yet been established.
                    //A value of 1 indicates that the connection is established and communication is possible.
                    //A value of 2 indicates that the connection is going through the closing handshake.
                    //A value of 3 indicates that the connection has been closed or could not be opened.
                    if( ws.readyState == 1){
                        try{
                            ws.close();
                        }catch(err){};
                    }
                    else if(ws.readyState == 0){
                    // Don't do anything, just wait for the connection to be stablished
                    }
                    else{
                        openSocket();
                    }
                };

                function checkTimeout(){
                    if(pendingSendMessages.length>0)
                        renewConnection();
                };

                function websocketOnClose(evt){
                    /* websocket is closed. */
                    console.debug('Connection is closed... event code: ' + evt.code + ', reason: ' + evt.reason);
                    // Some explanation on this error: http://stackoverflow.com/questions/19304157/getting-the-reason-why-websockets-closed
                    // In practice, on a unstable network (wifi with a lot of traffic for example) this error appears
                    // Got it with Chrome saying:
                    // WebSocket connection to 'ws://x.x.x.x:y/' failed: Could not decode a text frame as UTF-8.
                    // WebSocket connection to 'ws://x.x.x.x:y/' failed: Invalid frame header

                    try {
                        document.getElementById("loading").style.display = '';
                    } catch(err) {
                        console.log('Error hiding loading overlay ' + err.message);
                    }

                    failedConnections += 1;

                    console.debug('failed connections=' + failedConnections + ' queued messages=' + pendingSendMessages.length);

                    if(failedConnections > 3) {

                        // check if the server has been restarted - which would give it a new websocket address,
                        // new state, and require a reload
                        console.debug('Checking if GUI still up ' + location.href);

                        var http = new XMLHttpRequest();
                        http.open('HEAD', location.href);
                        http.onreadystatechange = function() {
                            if (http.status == 200) {
                                // server is up but has a new websocket address, reload
                                location.reload();
                            }
                        };
                        http.send();

                        failedConnections = 0;
                    }

                    if(evt.code == 1006){
                        renewConnection();
                    }

                };

                function websocketOnError(evt){
                    /* websocket is closed. */
                    /* alert('Websocket error...');*/
                    console.debug('Websocket error... event code: ' + evt.code + ', reason: ' + evt.reason);
                };

                function websocketOnOpen(evt){
                    if(ws.readyState == 1){
                        ws.send('connected');

                        try {
                            document.getElementById("loading").style.display = 'none';
                        } catch(err) {
                            console.log('Error hiding loading overlay ' + err.message);
                        }

                        failedConnections = 0;

                        while(pendingSendMessages.length>0){
                            ws.send(pendingSendMessages.shift()); /*without checking ack*/
                        }
                    }
                    else{
                        console.debug('onopen fired but the socket readyState was not 1');
                    }
                };

                function uploadFile(widgetID, eventSuccess, eventFail, eventData, file){
                    var url = '/';
                    var xhr = new XMLHttpRequest();
                    var fd = new FormData();
                    xhr.open('POST', url, true);
                    xhr.setRequestHeader('filename', file.name);
                    xhr.setRequestHeader('listener', widgetID);
                    xhr.setRequestHeader('listener_function', eventData);
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState == 4 && xhr.status == 200) {
                            /* Every thing ok, file uploaded */
                            var params={};params['filename']=file.name;
                            sendCallbackParam(widgetID, eventSuccess,params);
                            console.log('upload success: ' + file.name);
                        }else if(xhr.status == 400){
                            var params={};params['filename']=file.name;
                            sendCallbackParam(widgetID,eventFail,params);
                            console.log('upload failed: ' + file.name);
                        }
                    };
                    fd.append('upload_file', file);
                    xhr.send(fd);
                };
                </script>
</head><body id="68419720" class="BODY" onload="sendCallback('68419720','onload');" onerror="var params={};params['message']=event.message;
                params['source']=event.source;
                params['lineno']=event.lineno;
                params['colno']=event.colno;
                sendCallbackParam('68419720','onerror',params);
                return false;
            " ononline="sendCallback('68419720','ononline');" onpagehide="sendCallback('68419720','onpagehide');" onpageshow="
            var params={};
            params['width']=window.innerWidth;
            params['height']=window.innerHeight;
            sendCallbackParam('68419720','onpageshow',params);" onresize="
            var params={};
            params['width']=window.innerWidth;
            params['height']=window.innerHeight;
            sendCallbackParam('68419720','onresize',params);" data-parent-widget="68422096" style="margin:0px"><div id="loading" class="Container" data-parent-widget="68419720" style="margin:None;display:none"><div id="loading-animation" class="Widget" data-parent-widget="68421472" style="margin:None"></div></div><div id="68422504" class="VBox" data-parent-widget="68419768" style="margin:0px;display:flex;justify-content:flex-start;align-items:baseline;flex-direction:column;background-color:#64778d"><div id="68423248" class="HBox" data-parent-widget="68422504" style="margin:0px;display:flex;justify-content:space-around;align-items:flex-start;flex-direction:row;margin-right:auto;background-color:#64778d;position:static;order:-1"><button id="68509928" class="Button" onclick="sendCallback('68509928','onclick');" data-parent-widget="68423248" style="margin:3px 5px 3px 5px;height:26px;font-family:Helvetica;background-color:#283b5b;color:#FFFFFF;font-size:15px;position:static;order:-1">Come è fatto il corridoio?</button><textarea id="68510144" class="TextInput" autocomplete="off" onchange="var params={};params['new_value']=document.getElementById('68510144').value;sendCallbackParam('68510144','onchange',params);" data-parent-widget="68423248" style="margin:3px 5px 3px 5px;font-family:Helvetica;background-color:#f0f3f7;color:#000000;font-size:15px;height:156px;width:600px;position:static;order:-1"></textarea></div><div id="68423272" class="HBox" data-parent-widget="68422504" style="margin:0px;display:flex;justify-content:space-around;align-items:flex-start;flex-direction:row;margin-right:auto;background-color:#64778d;position:static;order:-1"><button id="68511752" class="Button" onclick="sendCallback('68511752','onclick');" data-parent-widget="68423272" style="margin:3px 5px 3px 5px;height:26px;font-family:Helvetica;background-color:#283b5b;color:#FFFFFF;font-size:15px;position:static;order:-1">Ci sono tesori?</button><textarea id="68511968" class="TextInput" autocomplete="off" onchange="var params={};params['new_value']=document.getElementById('68511968').value;sendCallbackParam('68511968','onchange',params);" data-parent-widget="68423272" style="margin:3px 5px 3px 5px;font-family:Helvetica;background-color:green;color:#000000;font-size:15px;height:78px;width:1000px;position:static;order:-1"></textarea></div><div id="68512520" class="HBox" data-parent-widget="68422504" style="margin:0px;display:flex;justify-content:space-around;align-items:flex-start;flex-direction:row;margin-right:auto;background-color:#64778d;position:static;order:-1"><button id="68513576" class="Button" onclick="sendCallback('68513576','onclick');" data-parent-widget="68512520" style="margin:3px 5px 3px 5px;height:26px;font-family:Helvetica;background-color:#283b5b;color:#FFFFFF;font-size:15px;position:static;order:-1">Cosa contiene?</button></div><div id="68513768" class="HBox" data-parent-widget="68422504" style="margin:0px;display:flex;justify-content:space-around;align-items:flex-start;flex-direction:row;margin-right:auto;background-color:#64778d;position:static;order:-1"><textarea id="88544256" class="TextInput" autocomplete="off" onchange="var params={};params['new_value']=document.getElementById('88544256').value;sendCallbackParam('88544256','onchange',params);" data-parent-widget="68513768" style="margin:3px 5px 3px 5px;font-family:Helvetica;background-color:#f0f3f7;color:#000000;font-size:15px;height:78px;width:1000px;position:static;order:-1"></textarea></div><div id="88544424" class="HBox" data-parent-widget="68422504" style="margin:0px;display:flex;justify-content:space-around;align-items:flex-start;flex-direction:row;margin-right:auto;background-color:#64778d;position:static;order:-1"><button id="88545480" class="Button" onclick="sendCallback('88545480','onclick');" data-parent-widget="88544424" style="margin:3px 5px 3px 5px;height:26px;font-family:Helvetica;background-color:#283b5b;color:#FFFFFF;font-size:15px;position:static;order:-1">Scopri come è fatta la stanza</button></div><div id="88546152" class="HBox" data-parent-widget="68422504" style="margin:0px;display:flex;justify-content:space-around;align-items:flex-start;flex-direction:row;margin-right:auto;background-color:#64778d;position:static;order:-1"><textarea id="88546680" class="TextInput_raw_onkeyup" rows="1" oninput="
                var elem = document.getElementById('88546680');
                var enter_pressed = (elem.value.indexOf('\n') > -1);
                if(enter_pressed){
                    elem.value = elem.value.split('\n').join('');
                    var params={};params['new_value']=elem.value;
                    sendCallbackParam('88546680','onchange',params);
                }" placeholder="Inserisci il numero di caselle della stanza" autocomplete="off" onchange="var params={};params['new_value']=document.getElementById('88546680').value;sendCallbackParam('88546680','onchange',params);" data-parent-widget="88546152" style="margin:3px 5px 3px 5px;resize:none;font-family:Helvetica;background-color:#f0f3f7;color:#000000;font-size:15px;height:78px;width:1000px;position:static;order:-1">12</textarea></div><div id="88546224" class="HBox" data-parent-widget="68422504" style="margin:0px;display:flex;justify-content:space-around;align-items:flex-start;flex-direction:row;margin-right:auto;background-color:#64778d;position:static;order:-1"><textarea id="88593000" class="TextInput" autocomplete="off" onchange="var params={};params['new_value']=document.getElementById('88593000').value;sendCallbackParam('88593000','onchange',params);" data-parent-widget="88546224" style="margin:3px 5px 3px 5px;font-family:Helvetica;background-color:#f0f3f7;color:#000000;font-size:15px;height:78px;width:1000px;position:static;order:-1">La stanza contiene tomba, scrigno</textarea></div><div id="88593168" class="HBox" data-parent-widget="68422504" style="margin:0px;display:flex;justify-content:space-around;align-items:flex-start;flex-direction:row;margin-right:auto;background-color:#64778d;position:static;order:-1"><button id="88594224" class="Button" onclick="sendCallback('88594224','onclick');" data-parent-widget="88593168" style="margin:3px 5px 3px 5px;height:26px;font-family:Helvetica;background-color:#283b5b;color:#FFFFFF;font-size:15px;position:static;order:-1">Ci sono mostri nella stanza?</button></div><div id="88594896" class="HBox" data-parent-widget="68422504" style="margin:0px;display:flex;justify-content:space-around;align-items:flex-start;flex-direction:row;margin-right:auto;background-color:#64778d;position:static;order:-1"><textarea id="88595424" class="TextInput" autocomplete="off" onchange="var params={};params['new_value']=document.getElementById('88595424').value;sendCallbackParam('88595424','onchange',params);" data-parent-widget="88594896" style="margin:3px 5px 3px 5px;font-family:Helvetica;background-color:#f0f3f7;color:#000000;font-size:15px;height:78px;width:1000px;position:static;order:-1"></textarea></div><div id="88595592" class="HBox" data-parent-widget="68422504" style="margin:0px;display:flex;justify-content:space-around;align-items:flex-start;flex-direction:row;margin-right:auto;background-color:#64778d;position:static;order:-1"><button id="88625360" class="Button" onclick="sendCallback('88625360','onclick');" data-parent-widget="88595592" style="margin:3px 5px 3px 5px;height:26px;font-family:Helvetica;background-color:#283b5b;color:#FFFFFF;font-size:15px;position:static;order:-1">Ci sono trabocchetti o porte segrete?</button></div><div id="88596192" class="HBox" data-parent-widget="68422504" style="margin:0px;display:flex;justify-content:space-around;align-items:flex-start;flex-direction:row;margin-right:auto;background-color:#64778d;position:static;order:-1"><textarea id="88626560" class="TextInput" autocomplete="off" onchange="var params={};params['new_value']=document.getElementById('88626560').value;sendCallbackParam('88626560','onchange',params);" data-parent-widget="88596192" style="margin:3px 5px 3px 5px;font-family:Helvetica;background-color:#f0f3f7;color:#000000;font-size:15px;height:78px;width:1000px;position:static;order:-1"></textarea></div><div id="88626728" class="HBox" data-parent-widget="68422504" style="margin:0px;display:flex;justify-content:space-around;align-items:flex-start;flex-direction:row;margin-right:auto;background-color:#64778d;position:static;order:-1"><textarea id="88627784" class="TextInput" autocomplete="off" onchange="var params={};params['new_value']=document.getElementById('88627784').value;sendCallbackParam('88627784','onchange',params);" data-parent-widget="88626728" style="margin:3px 5px 3px 5px;font-family:Helvetica;background-color:#f0f3f7;color:#000000;font-size:15px;height:78px;width:1000px;position:static;order:-1"></textarea></div><script id="68423200" class="Tag" data-parent-widget="68422504">window.onunload=function(e){sendCallback('68419768','on_window_close');return "close?";};</script></div></body></html>